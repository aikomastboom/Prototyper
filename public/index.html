<!DOCTYPE html><!-- @@import__app_main_json_ -->
{ "_availableModes" : [
    { "name": "none", "ace":"none" },
    { "name": "HTML", "ace":"html" },
    { "name": "Style", "ace":"css" },
    { "name": "Behaviour", "ace":"javascript" },
    { "name": "Text", "ace":"markdown" },
    { "name": "JSON", "ace":"json" }
        ]
}
<!-- @@_end_import__app_main_json -->
<!-- @@import_file__../README.md__into__app_main_readme -->
<!-- @@import_leftovers__app_main_index --><html>
<head>
    <!-- @@import_file__templates/head.html__into__app_templates_head -->
    <!-- @@template__app_templates_head__context__app_main -->
    <!-- @@remove_ -->
    <title>app/main/index</title>
    <!--<script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>-->
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet" type="text/css">
    <!--<link href="//netdna.bootstrapcdn.com/font-awesome/3.0.2/css/font-awesome.css" rel="stylesheet" type="text/css">-->
    <!-- @@import_file__style.css__into__app_main_style -->
    <!-- @@style__app_main_style -->
    <!-- @@_end_remove -->
    <!-- @@remove_ -->
    <link href="/style.css" rel="stylesheet" type="text/css">
    <!-- @@_end_remove -->
</head>

<body>
<!-- @@template__app_main_body__context__app_main -->
<!-- @@import__app_main_body_ -->
<div id="header">
    <div id="htext">
        Editing <b>index</b>
        <strong data-bind="text: _keys().length"></strong>

        <div data-bind="visible: _getMode()">
            mode: <strong data-bind="text: _getMode()"></strong>
        </div>
        <select data-bind="options: _availableModes(), optionsText: 'name', value: _selectedMode"></select>
    </div>
    <div class="navbar">
        <div class="navbar-inner">
            <div class="container">
                <a class="brand" href="#">Currently open</a>
                <div class="nav btn-toolbar">
                    <!-- ko foreach: _keys() -->
                    <div class="btn-group">
                        <a class="btn" data-bind="text: $data,
                            click: $root._goToAttribute,
                            css: { active: $data == $root._chosenAttributeId() }"></a>
                        <button class="btn"
                                data-bind="enable: false, click: $root._closeDoc">&times;</button>
                    </div>
                    <!-- /ko -->
                </div>
                <button class="btn pull-right" title="preview" data-bind="enable: $root._chosenAttributeId, click: $root._previewAttribute"><i class="icon-eye-open"></i></button>
                <!--<ul class="nav pull-right"><li>-->
                <div class="nav navbar-form pull-right">
                    <input type="text" class="span2"
                           data-bind="value: $root._newAttribute"/>
                </div>
                <!--</li></ul>-->
            </div>
        </div>
    </div>
</div>
<div id="content">
    <div id="tree">
        <ul>
            <li>
                <span data-bind="text: name"></span>
                <!--<ul data-bind="template: { name: 'nodeTmpl', foreach: nodes }"></ul>-->
            </li>
        </ul>
    </div>
    <div id="editor"></div>
</div>
<!-- @@import_file__templates/scripts.html__into__app_templates_scripts -->
<!-- @@template__app_templates_scripts__context__app_main -->
<!-- @@remove_ -->
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/knockout/2.2.1/knockout-min.js"></script>
<script src="//underscorejs.org/underscore-min.js"></script>
<script src="/lib/knockout/knockout.mapping-latest.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/knockout-validation/1.0.2/knockout.validation.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
<script src="/lib/knockout/knockout-bootstrap.min.js"></script>
<script src="/lib/markdown/markdown.js" type="text/javascript" charset="utf-8"></script>
<script src="/lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="/lib/ace/mode-html.js" type="text/javascript" charset="utf-8"></script>
<script src="/lib/ace/mode-javascript.js" type="text/javascript" charset="utf-8"></script>
<script src="/lib/ace/mode-css.js" type="text/javascript" charset="utf-8"></script>
<script src="/lib/ace/mode-markdown.js" type="text/javascript" charset="utf-8"></script>
<script src="/lib/ace/mode-json.js" type="text/javascript" charset="utf-8"></script>
<script src="//cdn.sockjs.org/sockjs-0.3.min.js"></script>
<script src="/lib/share/share.uncompressed.js"></script>
<script src="/lib/share/json.js"></script>
<script src="/lib/share/ace.js"></script>
<!-- @@_end_remove -->
<!-- @@template__app_main_behaviour__context__app_main -->
<!-- @@import__app_main_behaviour_ -->
<script>
var attribute = 'index';
var editor = ace.edit("editor");
var aceMode = null;
var session = editor.getSession();
var viewModel = null;
var viewModel_updating = false;
var doc = null;
var mainDoc = null;
editor.setReadOnly(true);

var setMode = function (attribute, mode) {
    console.log('setmode', attribute, mode);
    var ace_mode = mode;
    if (!mode || mode == 'none') {
        ace_mode = 'markdown';
    }
    if (mainDoc.snapshot
            && mainDoc.snapshot[attribute]) {
        aceMode = require("ace/mode/" + ace_mode).Mode;
        session.setMode(new aceMode());
        var currentMode = mainDoc.snapshot[attribute].mode;
        if (!currentMode) {
            currentMode = 'none';
        }
        console.log('modes', attribute, currentMode, mode);


        if (currentMode != mode) {
            console.log('mode differs', attribute, currentMode, mode);
            var op = [];
            if (mainDoc.snapshot[attribute].mode) {
                console.log('// remove', attribute, mode);
                op.push({
                    p: [attribute, 'mode'],
                    od: mainDoc.snapshot[attribute].mode

                })
            }
            if (mode && mode != 'none') {
                console.log('//insert', attribute, mode);
                op.push({
                    p: [attribute, 'mode'],
                    oi: mode
                });
            }
            mainDoc.submitOp(op, function (err, result) {
                console.log('err', err, 'result', result);
            });
        }
    }
};

var setDoc = function (attribute) {
    editor.setReadOnly(true);
    var mode = (mainDoc.snapshot
            && mainDoc.snapshot[attribute]
            && mainDoc.snapshot[attribute].mode
            ) || 'none';
    console.log('setDoc attribute, mode', attribute, mode);
    setMode(attribute, mode);
    //document.title = attribute;

    var docName = 'text:app:' + viewModel._id() + ':' + attribute;

    sharejs.open(docName, 'text', function (error, newDoc) {

        if (doc != null) {
            doc.close();
            doc.detach_ace();
        }

        doc = newDoc;

        if (error) {
            console.error(error);
            return;
        }
        doc.attach_ace(editor);
        editor.setReadOnly(false);
        editor.focus(); //To focus the ace editor
    });
};
var mapping = {
    'ignore': ["name", "version"]
};

function addComputed(doc) {
    var snapshot = doc.snapshot;
    snapshot._keys = _.filter(
            Object.keys(snapshot),
            function (key) {
                return key[0] != '_'
                        && key != 'name'
                        && key != 'version';
            });
}

function getExtensionForAttribute(attribute) {
    var mode = getModeForAttribute(attribute);
    if (mode && mode.ace() == 'markdown') {
        return '.md';
    } else {
        return '.html';
    }
}

function getModeForChosenAttribute() {
    var attribute = viewModel._chosenAttributeId();
    return getModeForAttribute(attribute)
}
function getModeForAttribute(attribute) {
    if (!attribute) {
        return null;
    }
    var mode = _.find(viewModel._availableModes(),
            function (mode) {
                return viewModel[attribute].mode && (mode.ace() == viewModel[attribute].mode());
            });
    if (mode) {
        return mode;
    } else {
        mode = _.find(viewModel._availableModes(),
                function (mode) {
                    return mode.ace() == 'none';
                });
        return mode;
    }
}

function updateSelectedMode() {
    var selectedMode = getModeForChosenAttribute();
    if (selectedMode) {
        console.log('setSelectedMode:', selectedMode.ace());
        viewModel._selectedMode(selectedMode);
    }
}

function open_in_new_tab(url) {
    var win = window.open(url, '_blank');
    win.focus();
}

function initViewModel(doc) {
    viewModel_updating = true;
    addComputed(doc);
    var snapshot = doc.snapshot;
    var viewModel = ko.mapping.fromJS(snapshot, mapping);
    viewModel._chosenAttributeId = ko.observable();
    viewModel._newAttribute = ko.observable();
    viewModel._selectedMode = ko.observable();


    // Behaviours
    viewModel._goToAttribute = function (attribute) {
        viewModel._chosenAttributeId(attribute);
        updateSelectedMode();
        setDoc(attribute);
    };
    viewModel._newAttribute.subscribe(function (newValue) {
        if (newValue) {
            mainDoc.submitOp({
                p: [newValue],
                oi: {}
            }, function (err, result) {
                viewModel._newAttribute("");
            })
        }
    });

    viewModel._previewAttribute = function () {
        var id = viewModel._chosenAttributeId();
        if (id) {
            var ext = getExtensionForAttribute(id);
            var url = '/page/app/main.'+id+ext;
            open_in_new_tab(url);
        }

    }
    viewModel._getMode = ko.computed(function () {
        var id = viewModel._chosenAttributeId();
        return id && viewModel[id].mode;
    });
    viewModel._selectedMode.subscribe(function (newValue) {
        if (newValue && !viewModel_updating) {
            console.log('_selectedMode, newValue', newValue.ace());
            setMode(viewModel._chosenAttributeId(), newValue.ace());
        }
    });
    viewModel._closeDoc = function (attribute) {
        console.log('closing ', attribute);
    };
    ko.applyBindings(viewModel);
    window.viewModel = viewModel;
    console.log('viewModel', viewModel);
    viewModel_updating = false;
}

function updateViewModel(doc) {
    viewModel_updating = true;
    addComputed(doc);
    ko.mapping.fromJS(doc.snapshot, viewModel);
    console.log('updated viewModel', viewModel);
    updateSelectedMode();
    viewModel_updating = false;

}

sharejs.open('json:app:main', 'json', function (error, main) {
    if (error) {
        console.log('error opening app:main:json', error, main);
    } else {
        console.log('yes!!', main);
        mainDoc = main;
        var snapshot = main.snapshot;
        if (snapshot == null) {
            //TODO test/handle this situation
            console.log('// TODO no data for main yet??');
        } else {
            initViewModel(main)
        }
        main.on('change', function () {
            console.log('main changed!!', main.snapshot, viewModel);
            if (main.snapshot && viewModel) {
                updateViewModel(main);
            } else {
                initViewModel(main)
            }
        });
    }
})
</script>
<!-- @@_end_import__app_main_behaviour -->
<!-- @@_end_import__app_main_body -->
<!-- @@import_ _app_config_json_ -->

<!-- @@_end_import_ _app_config_json -->
</body>
</html>	


<!DOCTYPE HTML>
<html>
<head>
    <link href="style.css" rel="stylesheet" type="text/css">
    <title>app/main/behaviour</title>
</head>

<body>
<div id="header">
    <div id="htext">
        Editing <b>behaviour</b>
    </div>
</div>

<div id="editor"></div>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/knockout/2.2.1/knockout-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/knockout-validation/1.0.2/knockout.validation.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
<script src="lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<!--<script src="lib/ace/mode-html.js" type="text/javascript" charset="utf-8"></script>-->
<script src="lib/ace/mode-javascript.js" type="text/javascript" charset="utf-8"></script>
<!--<script src="lib/ace/mode-css.js" type="text/javascript" charset="utf-8"></script>-->
<!--<script src="lib/ace/mode-markdown.js" type="text/javascript" charset="utf-8"></script>-->
<script src="//cdn.sockjs.org/sockjs-0.3.min.js"></script>
<!--<script src="/channel/bcsocket.js"></script>-->
<!--<script src="/socket.io/socket.io.js"></script>-->
<script src="/share/share.uncompressed.js"></script>
<script src="/share/json.js"></script>
<script src="/share/ace.js"></script>

<script>
    var attribute = 'behaviour';
    var editor = ace.edit("editor");
    var aceMode = require("ace/mode/javascript").Mode;
    var session = editor.getSession();
    session.setMode(new aceMode());

    sharejs.open('json:app:main','json', function (error, main) {
        var indexField = null;
        if (error) {
            console.log('error opening app:main:json', error, main);
        } else {
            console.log('yes!!',main);
            if (main.snapshot == null) {
                main.submitOp([
                    { p: [], oi: {name:'main'}, od: null }
                ]);
            }
            function openIndex() {
                if (main.snapshot._id && !indexField){
                    indexField = 'busy';
                    console.log('main.snapshot._id',main.snapshot._id);
                    sharejs.open('text:app:'+main.snapshot._id+':'+attribute, 'text', function(error, index) {
                        if (error) {
                            console.log('error opening text:app:'+main.snapshot._id+':'+attribute, error, index);
                            indexField=null;
                        } else {
                            console.log('yes index!!',index);
                            indexField=index;
                            index.attach_ace(editor);
                        }
                    });
                }
            }
            openIndex();
            main.on('change', function (op) {
                console.log('main:change',op,main.snapshot);
                openIndex();
            });


        }
    })
</script>
</body>
</html>	

